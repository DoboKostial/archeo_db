{% extends "base.html" %}
{% block content %}
<div class="container py-4" style="max-width: 480px;">
  <h2 class="mb-3">Sign in</h2>
  <form id="loginForm" method="POST" action="{{ url_for('auth.login') }}">
    <div class="mb-3">
      <label for="email" class="form-label">Email</label>
      <input type="email" class="form-control" id="email" name="email" autocomplete="username" required>
    </div>
    <div class="mb-3">
      <label for="password" class="form-label">Password</label>
      <input type="password" class="form-control" id="password" name="password" autocomplete="current-password" required>
    </div>
    <input type="hidden" name="next" value="{{ request.args.get('next','') }}">
    <button type="submit" class="btn btn-primary w-100" id="loginBtn">Login</button>
    <div class="form-text mt-2"><a href="{{ url_for('auth.forgot_password') }}">Forgot password?</a></div>
  </form>
</div>
<script>
(function(){
  const form = document.getElementById('loginForm');
  const btn  = document.getElementById('loginBtn');

  form.addEventListener('submit', async (ev) => {
    ev.preventDefault(); // prevent native submit (avoids double POST)
    btn.disabled = true;

    const fd = new FormData(form);
    try {
      const res = await fetch(form.action, {
        method: 'POST',
        body: fd,
        headers: {'X-Requested-With': 'fetch', 'Accept':'application/json'}
      });

      const ct = (res.headers.get('content-type') || '').toLowerCase();
      if (ct.includes('application/json')) {
        const data = await res.json();
        if (data.ok) {
          window.location.href = data.redirect || '/';
          return;
        } else {
          alert(data.error || 'Login failed.');
          btn.disabled = false;
          return;
        }
      } else {
        // Server may have redirected with HTML; follow it
        window.location.href = res.url || '/';
      }
    } catch (e) {
      console.error('Error while login:', e);
      alert('Network error during login.');
      btn.disabled = false;
    }
  }, { once: true }); // ensure we don't attach multiple handlers
})();
</script>
{% endblock %}