{# app/templates/polygons.html #}
{% extends "base.html" %}
{% block title %}Polygons{% endblock %}

{% block content %}
<div class="alert alert-info" role="alert">
  You are working with database <strong>{{ selected_db }}</strong>.
</div>

<div class="container mt-3">

  <!-- Row 1: two top panels (manual / TXT polygon insert) -->
  <div class="row g-3">
  
  <!-- Manual create -->
<div class="col-md-6">
  <div class="p-3 rounded-3 border bg-light">
    <h4 class="mb-3 d-flex align-items-center gap-2">
  Manual polygon (by point ranges in DB)
  <button type="button"
          class="btn btn-sm btn-outline-secondary"
          data-bs-toggle="modal"
          data-bs-target="#helpManualPolygon"
          title="Help">
    ?
  </button>
</h4>

    <form method="POST" action="{{ url_for('polygons.new_polygon_manual') }}">
      <!-- Polygon metadata -->
      <div class="row g-2">
        <div class="col-md-8">
          <label class="form-label">Polygon name</label>
          <input type="text" class="form-control" name="polygon_name" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Parent polygon</label>
          <input type="text" class="form-control" name="parent_name" list="parent-polygons" placeholder="optional">
          <datalist id="parent-polygons">
            {% for a in polygons %}
              <option value="{{ a.name }}"></option>
            {% endfor %}
          </datalist>
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md-6">
          <label class="form-label">Allocation reason</label>
          <select name="allocation_reason" class="form-control" required>
            <option value="" selected disabled>-- select --</option>
            <option value="physical_separation">physical_separation</option>
            <option value="research_phase">research_phase</option>
            <option value="horizontal_stratigraphy">horizontal_stratigraphy</option>
            <option value="other">other</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Notes</label>
          <input type="text" class="form-control" name="notes" placeholder="optional">
        </div>
      </div>

      <!-- TOP ranges -->
      <div class="mt-3">
        <div class="d-flex align-items-center mb-2">
          <h6 class="mb-0 me-2">TOP ranges (FROM–TO)</h6>
          <small class="text-muted">(upper/top polygon points)</small>
        </div>

        <div id="top-ranges-container">
          <div class="row g-2 align-items-end range-row">
            <div class="col-5">
              <label class="form-label">FROM</label>
              <input type="number" class="form-control" name="top_range_from[]">
            </div>
            <div class="col-5">
              <label class="form-label">TO</label>
              <input type="number" class="form-control" name="top_range_to[]">
            </div>
            <div class="col-2">
              <button type="button" class="btn btn-outline-secondary mt-4" onclick="addRangeRow('top')">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM ranges -->
      <div class="mt-3">
        <div class="d-flex align-items-center mb-2">
          <h6 class="mb-0 me-2">BOTTOM ranges (FROM–TO)</h6>
          <small class="text-muted">(lower/bottom polygon points)</small>
        </div>

        <div id="bottom-ranges-container">
          <div class="row g-2 align-items-end range-row">
            <div class="col-5">
              <label class="form-label">FROM</label>
              <input type="number" class="form-control" name="bottom_range_from[]">
            </div>
            <div class="col-5">
              <label class="form-label">TO</label>
              <input type="number" class="form-control" name="bottom_range_to[]">
            </div>
            <div class="col-2">
              <button type="button" class="btn btn-outline-secondary mt-4" onclick="addRangeRow('bottom')">+</button>
            </div>
          </div>
        </div>

        <small class="text-muted d-block mt-2">
          Tip: You can define only TOP or only BOTTOM ranges (at least one is required).
        </small>
      </div>

      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Save & Rebuild</button>
      </div>
    </form>
  </div>
</div>

<!-- JS adding another row/points bulk -->
<script>
  function addRangeRow(side) {
    const containerId = (side === 'top') ? 'top-ranges-container' : 'bottom-ranges-container';
    const fromName = (side === 'top') ? 'top_range_from[]' : 'bottom_range_from[]';
    const toName   = (side === 'top') ? 'top_range_to[]'   : 'bottom_range_to[]';

    const container = document.getElementById(containerId);

    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end range-row mt-2';

    row.innerHTML = `
      <div class="col-5">
        <label class="form-label">FROM</label>
        <input type="number" class="form-control" name="${fromName}">
      </div>
      <div class="col-5">
        <label class="form-label">TO</label>
        <input type="number" class="form-control" name="${toName}">
      </div>
      <div class="col-2 d-flex gap-1">
        <button type="button" class="btn btn-outline-secondary mt-4" onclick="addRangeRow('${side}')">+</button>
        <button type="button" class="btn btn-outline-danger mt-4" onclick="removeRangeRow(this)">−</button>
      </div>
    `;

    container.appendChild(row);
  }

  function removeRangeRow(btn) {
    const row = btn.closest('.range-row');
    if (row) row.remove();
  }
</script>




<!-- Upload from TXT/CSV -->
<div class="col-md-6">
  <div class="p-3 rounded-3 border bg-light">
    <h4 class="mb-3 d-flex align-items-center gap-2">
  Import polygon(s) from TXT/CSV
  <button type="button"
          class="btn btn-sm btn-outline-secondary"
          data-bs-toggle="modal"
          data-bs-target="#helpUploadPolygon"
          title="Help">
    ?
  </button>
</h4>


    <form action="{{ url_for('polygons.upload_polygons') }}" method="post" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label">Select TXT/CSV file</label>
        <input type="file" name="file" class="form-control" accept=".csv,.txt" required>
        <small class="text-muted">
          Format: id_pts,x,y,h,code,polygon_name (polygon_name is last column)
        </small>
      </div>

      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Source EPSG</label>
          <select name="epsg" class="form-control" required>
            <option value="5514">S-JTSK / Křovák East North (EPSG:5514)</option>
            <option value="4326">WGS 84 (EPSG:4326)</option>
            <option value="3857">Web Mercator (EPSG:3857)</option>
            <option value="32633">UTM zone 33N (EPSG:32633)</option>
            <option value="32633">UTM zone 43N (EPSG:32643)</option>
            <option value="3035">ETRS89 / LAEA Europe (EPSG:3035)</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Imported side</label>
          <select name="side" class="form-control" required>
            <option value="top" selected>TOP (upper)</option>
            <option value="bottom">BOTTOM (lower)</option>
          </select>
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md-6">
          <label class="form-label">Allocation reason</label>
          <select name="allocation_reason" class="form-control" required>
            <option value="" selected disabled>-- select --</option>
            <option value="physical_separation">physical_separation</option>
            <option value="research_phase">research_phase</option>
            <option value="horizontal_stratigraphy">horizontal_stratigraphy</option>
            <option value="other">other</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">Parent polygon (optional)</label>
          <input type="text" class="form-control" name="parent_name" list="parent-polygons-upload" placeholder="optional">
          <datalist id="parent-polygons-upload">
            {% for p in polygons %}
              <option value="{{ p.name }}"></option>
            {% endfor %}
          </datalist>
        </div>
      </div>

      <div class="mt-2">
        <label class="form-label">Notes (optional)</label>
        <input type="text" class="form-control" name="notes" placeholder="optional">
      </div>

      <button type="submit" class="btn btn-primary mt-3">Upload → Save → Rebuild</button>
    </form>
  </div>
</div>


<!-- Row 2: Existing polygons list (full width) -->
<div class="row g-3 mt-2">
  <!-- Existing polygons + actions -->
  <div class="col-12">
    <div class="p-3 rounded-3 border">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Existing polygons</h4>
        <!-- Here buttons for actions -->
        <div class="d-flex gap-2">
          <form action="{{ url_for('polygons.rebuild_all_polygons') }}" method="post" class="me-2">
            <button type="submit" class="btn btn-outline-warning btn-sm">Rebuild geometry (all)</button>
          </form>

          <button type="button" class="btn btn-success btn-sm" 
          data-bs-toggle="modal"  data-bs-target="#modalShowAllPolygons"> Show all
          </button>
          
          <button type="button" class="btn btn-success btn-sm"
          data-bs-toggle="modal" data-bs-target="#modalShowPolygonHierarchy"> Show hierarchy
          </button>
                       
          <a href="{{ url_for('polygons.download_polygons') }}" class="btn btn-success btn-sm">Export SHP</a>
        </div>
      
      </div>

      {% if polygons and polygons|length %}
        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle mb-0 w-100">
            <thead class="table-light">
              <tr>
                <th style="width:70px;">ID</th>
                <th>Name</th>
                <th style="width:120px;">Parent</th>
                <th style="width:250px;">Allocation reason</th>
                <th class="text-center" style="width:80px;">TOP</th>
                <th class="text-center" style="width:80px;">BOTTOM</th>
                <th class="text-end" style="width:100px;">POINTS NR.</th>
                <th class="text-end" style="width:120px;">SRID / EPSG</th>
                <th class="text-end" style="width:50px;">DELETE</th>
              </tr>
            </thead>
            <tbody>
              {% for p in polygons %}
              <tr>
                <td>{{ p.id }}</td>
                <td class="text-break">{{ p.name }}</td>

                <td class="text-break">
                  {% if p.parent %}
                    {{ p.parent }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td>
                  {{ p.allocation_reason }}
                </td>

                <td class="text-center">
                  {% if p.has_top %}
                    <span class="badge bg-success">yes</span>
                  {% else %}
                    <span class="badge bg-secondary">no</span>
                  {% endif %}
                </td>

                <td class="text-center">
                  {% if p.has_bottom %}
                    <span class="badge bg-success">yes</span>
                  {% else %}
                    <span class="badge bg-secondary">no</span>
                  {% endif %}
                </td>

                <td class="text-end">{{ p.points }}</td>

                <td class="text-end">
                  {% if p.srid %}
                    {{ p.srid }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  <button type="button"
                  class="btn btn-sm btn-outline-danger"
                  data-bs-toggle="modal"
                  data-bs-target="#deletePolygonModal"
                  data-polygon-name="{{ p.name }}">
                  Delete
                  </button>
                </td>

              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No polygons stored yet.</p>
      {% endif %}
    </div>
  </div>
</div>



<!-- 3. row ========= GRAPHIC DOCUMENTATION (for polygons) ========= -->
<div class="container mt-4">
  <fieldset class="border p-3 bg-success-subtle">
    <legend class="w-auto px-2">Graphic documentation</legend>

    <!-- Polygon selector -->
    <div class="row g-2 align-items-end mb-3">
      <div class="col-md-6">
        <label class="form-label">Select polygon</label>
        <select id="polyDocSelect" class="form-select">
          <option value="" selected>-- select polygon --</option>
          {% for p in polygons %}
            <option value="{{ p.name }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        <div class="alert alert-light border mb-0 py-2">
          <span class="text-muted">Selected:</span>
          <strong id="polyDocSelectedLabel" class="ms-1">—</strong>
        </div>
      </div>
    </div>

    <!-- Action buttons -->
    <div class="d-flex gap-2 flex-wrap">
      <button type="button" class="btn btn-primary polyDocBtn"
              data-bs-toggle="modal" data-bs-target="#modalPolyPhotos">
        Upload photos
      </button>
      <button type="button" class="btn btn-secondary polyDocBtn"
              data-bs-toggle="modal" data-bs-target="#modalPolySketches">
        Upload sketches
      </button>
      <button type="button" class="btn btn-warning polyDocBtn"
              data-bs-toggle="modal" data-bs-target="#modalPolyPhotograms">
        Upload photograms
      </button>
    </div>

    <small class="text-muted d-block mt-2">Allowed: .jpeg .jpg .png .tiff .svg .pdf</small>
  </fieldset>
</div>

<!-- Photos modal - opens window for photo selection -->
<div class="modal fade" id="modalPolyPhotos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formPolyPhotos"
          method="post"
          action="{{ url_for('polygons.upload_polygon_media', media_type='photos') }}"
          enctype="multipart/form-data"
          class="modal-content polyDocForm">
      <div class="modal-header">
        <h5 class="modal-title">Upload photos to polygon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="polygon_name" class="polyDocHidden" value="">

        <div id="filesPolyPhotos" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2"
                 accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                onclick="addFileInput('filesPolyPhotos')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Photo type</label>
            <input type="text" name="photo_typ" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" name="datum" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Author (email)</label>
            <input type="email" name="author" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">Polygon: <span class="polyDocPreview"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>


<!-- Sketches modal - opens window for sketches selection-->
 <div class="modal fade" id="modalPolySketches" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formPolySketches"
          method="post"
          action="{{ url_for('polygons.upload_polygon_media', media_type='sketches') }}"
          enctype="multipart/form-data"
          class="modal-content polyDocForm">
      <div class="modal-header">
        <h5 class="modal-title">Upload sketches to polygon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="polygon_name" class="polyDocHidden" value="">

        <div id="filesPolySketches" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2"
                 accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                onclick="addFileInput('filesPolySketches')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Sketch type</label>
            <input type="text" name="sketch_typ" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Author (email)</label>
            <input type="email" name="author" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" name="datum" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">Polygon: <span class="polyDocPreview"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- Photograms modal - opens window for photograms selection -->
 <div class="modal fade" id="modalPolyPhotograms" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formPolyPhotograms"
          method="post"
          action="{{ url_for('polygons.upload_polygon_media', media_type='photograms') }}"
          enctype="multipart/form-data"
          class="modal-content polyDocForm">
      <div class="modal-header">
        <h5 class="modal-title">Upload photograms to polygon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" name="polygon_name" class="polyDocHidden" value="">

        <div id="filesPolyPhotograms" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2"
                 accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                onclick="addFileInput('filesPolyPhotograms')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Photogram type</label>
            <input type="text" name="photogram_typ" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">Polygon: <span class="polyDocPreview"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- JS logic for add another inputs in modals for graphic documentation -->
<script>
  // Add another <input type="file" ...> into a container
  function addFileInput(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const inp = document.createElement('input');
    inp.type = 'file';
    inp.name = 'files';
    inp.className = 'form-control mb-2';
    inp.multiple = true;
    inp.accept = '.jpeg,.jpg,.png,.tiff,.svg,.pdf';

    container.appendChild(inp);
  }

  (function () {
    const sel = document.getElementById('polyDocSelect');
    const label = document.getElementById('polyDocSelectedLabel');

    // all hidden polygon_name inputs in modals
    const hiddenInputs = document.querySelectorAll('.polyDocHidden');

    // previews in modal footers
    const previews = document.querySelectorAll('.polyDocPreview');

    // optional: disable opening modal until polygon selected
    const modalButtons = document.querySelectorAll('.polyDocBtn');

    function applyPolygon() {
      const name = (sel.value || '').trim();

      label.textContent = name ? name : '—';
      hiddenInputs.forEach(i => i.value = name);
      previews.forEach(p => p.textContent = name ? name : '—');

      // UX guard: disable buttons until selection
      modalButtons.forEach(b => b.disabled = !name);
    }

    sel.addEventListener('change', applyPolygon);
    applyPolygon();

    // Guard on submit: ensure polygon_name present
    document.querySelectorAll('.polyDocForm').forEach(form => {
      form.addEventListener('submit', (e) => {
        const val = form.querySelector('.polyDocHidden')?.value?.trim();
        if (!val) {
          e.preventDefault();
          alert('Please select a polygon first.');
        }
      });
    });
  })();
</script>


<!-- Providing numbering of rows in polygons list -->
<script>
function addRangeRow() {
  const container = document.getElementById('ranges-container');
  const row = document.createElement('div');
  row.className = 'row g-2 align-items-end range-row mt-2';
  row.innerHTML = `
    <div class="col-5">
      <label class="form-label">FROM</label>
      <input type="number" class="form-control" name="range_from[]" required>
    </div>
    <div class="col-5">
      <label class="form-label">TO</label>
      <input type="number" class="form-control" name="range_to[]" required>
    </div>
    <div class="col-2">
      <button type="button" class="btn btn-outline-danger" onclick="this.closest('.range-row').remove()">Remove</button>
    </div>
  `;
  container.appendChild(row);
}
</script>

<!-- ==== HERE MODALS FOR HELP IN WEB INTERFACE -->
<!-- Help modal: Manual polygon -->
<div class="modal fade" id="helpManualPolygon" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Help: Manual polygon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% include "help/polygons_manual_help.html" %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Help modal: Upload polygon(s) -->
<div class="modal fade" id="helpUploadPolygon" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Help: Upload polygon(s)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% include "help/polygons_upload_help.html" %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- ==== HERE MODALS FOR MAP ETC... -->
<!-- Polygon map preview modal - for one polygon from polygon list -->
<div class="modal fade" id="polygonMapModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Polygon preview: <span id="polyModalTitle" class="fw-bold"></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- TOP/BOTTOM toggles -->
        <div class="d-flex flex-wrap gap-3 mb-2 align-items-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="chkTop" checked>
            <label class="form-check-label" for="chkTop">Show TOP</label>
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="chkBottom" checked>
            <label class="form-check-label" for="chkBottom">Show BOTTOM</label>
          </div>

          <small class="text-muted">Map uses WGS844 (EPSG:4326)</small>
        </div>

        <!-- Map -->
        <div id="polygonMap"
             style="height: 60vh; width: 100%; border-radius: 12px; border: 1px solid #ddd;">
        </div>

        <!-- Message area -->
        <div id="polyMapMsg" class="text-muted mt-2" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete polygon confirm modal -->
<div class="modal fade" id="deletePolygonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete polygon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="{{ url_for('polygons.delete_polygon') }}">
        <div class="modal-body">
          <input type="hidden" name="polygon_name" id="deletePolygonName">

          <p class="mb-0">
            Do you really want to delete polygon
            <strong id="deletePolygonLabel"></strong>?
          </p>
          <small class="text-muted">
            This deletes only the selected polygon. Its children will be re-linked to the deleted polygon’s parent.
          </small>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script>
  // Fill delete modal with polygon name
  const deleteModalEl = document.getElementById('deletePolygonModal');
  deleteModalEl.addEventListener('shown.bs.modal', (event) => {
    const btn = event.relatedTarget;
    const name = btn.getAttribute('data-polygon-name') || '';
    document.getElementById('deletePolygonName').value = name;
    document.getElementById('deletePolygonLabel').textContent = name;
  });
</script>


<!-- Modal: Show all polygons (Leaflet) -->

<div class="modal fade" id="modalShowAllPolygons" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">All polygons (TOP + BOTTOM)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-light border py-2 mb-2">
          <small class="text-muted">
            Layers: <strong>TOP</strong> and <strong>BOTTOM</strong>. You can toggle them in the layer control.
          </small>
        </div>

        <div id="mapAllPolygons" style="height: 70vh; width: 100%; border: 1px solid #ddd; border-radius: 8px;"></div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto" id="allPolygonsStatus">—</span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal: Show hierarchy (nested boxes: parent contains children) -->
<div class="modal fade" id="modalShowPolygonHierarchy" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Polygon hierarchy (box-in-box)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-light border py-2 mb-2">
          <small class="text-muted">
            Parent polygon <strong>contains</strong> its child polygons (nested boxes).
          </small>
        </div>

        <!-- Scrollable canvas -->
        <div class="border rounded p-2"
             style="width:100%; overflow:auto; background:#ffffff;">
          <!-- Root container for nested boxes -->
          <div id="polyHierarchyNested"
               style="
                 display:flex;
                 flex-wrap:wrap;
                 gap:10px;
                 align-items:flex-start;
                 min-width:1200px;
                 min-height:600px;
               ">
            <!-- JS will render boxes here -->
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto" id="hierarchyStatus">—</span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>




<script>
/* -------------------------
   A) Show all polygons (Leaflet)
-------------------------- */

let _allPolyMap = null;
let _allPolyLayers = { top: null, bottom: null };
let _allPolyLayerCtrl = null;

function initAllPolygonsMap() {
  if (_allPolyMap) return _allPolyMap;

  // You already use Leaflet elsewhere; reuse your tile layer choice if you have one.
  _allPolyMap = L.map('mapAllPolygons', { preferCanvas: true });

  // Basic OSM tiles (replace with your own basemap if you already have one)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(_allPolyMap);

  return _allPolyMap;
}

async function loadAllPolygonsToMap() {
  const statusEl = document.getElementById('allPolygonsStatus');
  statusEl.textContent = 'Loading…';

  const map = initAllPolygonsMap();

  // Clear old layers
  if (_allPolyLayers.top) map.removeLayer(_allPolyLayers.top);
  if (_allPolyLayers.bottom) map.removeLayer(_allPolyLayers.bottom);
  if (_allPolyLayerCtrl) map.removeControl(_allPolyLayerCtrl);

  const resp = await fetch('{{ url_for("polygons.polygons_geojson") }}?mode=all', { cache: 'no-store' });
  if (!resp.ok) {
    statusEl.textContent = 'Failed to load data.';
    throw new Error('Failed to fetch polygons geojson');
  }
  const data = await resp.json();

  const topFeatures = [];
  const bottomFeatures = [];

  for (const item of (data.top || [])) {
    if (item.geojson) topFeatures.push({
      type: 'Feature',
      properties: { name: item.name, side: 'top' },
      geometry: item.geojson
    });
  }

  for (const item of (data.bottom || [])) {
    if (item.geojson) bottomFeatures.push({
      type: 'Feature',
      properties: { name: item.name, side: 'bottom' },
      geometry: item.geojson
    });
  }

  // Styles: TOP vs BOTTOM
  const topStyle = { color: '#1f77b4', weight: 3, fillOpacity: 0.05 };
  const bottomStyle = { color: '#d62728', weight: 3, fillOpacity: 0.05 };

  _allPolyLayers.top = L.geoJSON({ type: 'FeatureCollection', features: topFeatures }, {
    style: topStyle,
    onEachFeature: (feature, layer) => {
      const n = feature?.properties?.name || '';
      layer.bindPopup(`<strong>${n}</strong><br><small>TOP</small>`);
    }
  }).addTo(map);

  _allPolyLayers.bottom = L.geoJSON({ type: 'FeatureCollection', features: bottomFeatures }, {
    style: bottomStyle,
    onEachFeature: (feature, layer) => {
      const n = feature?.properties?.name || '';
      layer.bindPopup(`<strong>${n}</strong><br><small>BOTTOM</small>`);
    }
  }).addTo(map);

  // Layer control
  _allPolyLayerCtrl = L.control.layers(null, {
    'Top edges': _allPolyLayers.top,
    'Bottom edges': _allPolyLayers.bottom
  }, { collapsed: false }).addTo(map);

  // Fit bounds
  const allBounds = [];
  if (_allPolyLayers.top.getLayers().length) allBounds.push(_allPolyLayers.top.getBounds());
  if (_allPolyLayers.bottom.getLayers().length) allBounds.push(_allPolyLayers.bottom.getBounds());

  if (allBounds.length) {
    // combine bounds
    let b = allBounds[0];
    for (let i = 1; i < allBounds.length; i++) b = b.extend(allBounds[i]);
    map.fitBounds(b.pad(0.05));
    statusEl.textContent = `Loaded TOP: ${topFeatures.length}, BOTTOM: ${bottomFeatures.length}`;
  } else {
    map.setView([0, 0], 2);
    statusEl.textContent = 'No geometries to display.';
  }

  // Fix Leaflet sizing in modal
  setTimeout(() => map.invalidateSize(), 150);
}

// Hook modal open
document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('modalShowAllPolygons');
  if (modalEl) {
    modalEl.addEventListener('shown.bs.modal', () => {
      loadAllPolygonsToMap().catch(err => console.error(err));
    });
  }
});


/* -------------------------
   B) Polygon hierarchy (Box diagram SVG)
-------------------------- */

function buildHierarchy(nodes) {
  const byName = new Map();
  const children = new Map();
  nodes.forEach(n => {
    byName.set(n.name, n);
    children.set(n.name, []);
  });
  nodes.forEach(n => {
    if (n.parent && children.has(n.parent)) children.get(n.parent).push(n.name);
  });

  const roots = nodes
    .filter(n => !n.parent || !byName.has(n.parent))
    .map(n => n.name)
    .sort((a,b)=>a.localeCompare(b));

  // sort children for stable output
  for (const [k, arr] of children.entries()) arr.sort((a,b)=>a.localeCompare(b));

  return { children, roots };
}

function renderNodeNested(name, childrenMap) {
  const box = document.createElement('div');
  box.className = 'poly-box';

  const title = document.createElement('div');
  title.className = 'poly-box-title';
  title.textContent = name;
  box.appendChild(title);

  const kids = childrenMap.get(name) || [];
  if (kids.length) {
    const ch = document.createElement('div');
    ch.className = 'poly-children';
    kids.forEach(k => ch.appendChild(renderNodeNested(k, childrenMap)));
    box.appendChild(ch);
  }

  return box;
}

async function loadHierarchyNested() {
  const statusEl = document.getElementById('hierarchyStatus');
  const root = document.getElementById('polyHierarchyNested');
  statusEl.textContent = 'Loading…';
  root.innerHTML = '';

  const resp = await fetch('{{ url_for("polygons.polygons_geojson") }}?mode=hierarchy', { cache: 'no-store' });
  if (!resp.ok) {
    statusEl.textContent = 'Failed to load hierarchy.';
    return;
  }
  const data = await resp.json();
  const nodes = data.nodes || [];
  if (!nodes.length) {
    statusEl.textContent = 'No polygons.';
    return;
  }

  const g = buildHierarchy(nodes);
  g.roots.forEach(r => root.appendChild(renderNodeNested(r, g.children)));
  statusEl.textContent = `Roots: ${g.roots.length}, Nodes: ${nodes.length}`;
}

document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('modalShowPolygonHierarchy');
  if (modalEl) {
    modalEl.addEventListener('shown.bs.modal', () => loadHierarchyNested());
  }
});
</script>


{% endblock %}
