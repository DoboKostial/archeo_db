{# app/templates/polygons.html #}
{% extends "base.html" %}

{% block title %}Polygons{% endblock %}

{% block content %}
<div class="alert alert-info" role="alert">
    You are working with database <strong>{{ selected_db }}</strong>.
</div>

<div class="container mt-4">

    <!-- A) Manual polygon creation (by geodetic point ranges) -->
    <h2>Create polygon manually (by ranges of geodetic points)</h2>
    <form method="POST" action="{{ url_for('polygons.new_polygon_manual') }}">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Polygon ID</label>
                <input type="number" class="form-control" name="id_polygon" required>
            </div>
            <div class="col-md-9">
                <label class="form-label">Polygon name (description)</label>
                <input type="text" class="form-control" name="polygon_name" required>
            </div>
        </div>

        <div class="mt-4">
            <h5>Ranges (FROMâ€“TO)</h5>
            <p class="text-muted mb-2">
                Add one or more continuous ranges of measured point IDs (inclusive). All ranges will be merged,
                ordered by <code>id_pts</code>, and used to build a single closed boundary.
            </p>

            <div id="ranges-container">
                <div class="row g-3 align-items-end range-row">
                    <div class="col-md-3">
                        <label class="form-label">FROM</label>
                        <input type="number" class="form-control" name="range_from[]" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">TO</label>
                        <input type="number" class="form-control" name="range_to[]" required>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-secondary" onclick="addRangeRow()">+ Add range</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 mb-5">
            <button type="submit" class="btn btn-primary">Save</button>
        </div>
    </form>

    <!-- Visual divider -->
    <div class="position-relative my-4">
        <hr>
        <div class="position-absolute top-50 start-50 translate-middle bg-body px-3 text-muted small">
            OR UPLOAD FROM TOTALSTATION TEXTFILE
        </div>
    </div>

    {# ======= Your existing content (unchanged) ======= #}

    <h2>Existing polygons</h2>
    {% if polygons %}
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Polygon name</th>
                <th>Number of points</th>
                <th>EPSG</th>
            </tr>
        </thead>
        <tbody>
            {% for polygon in polygons %}
            <tr>
                <td>{{ polygon.name }}</td>
                <td>{{ polygon.points }}</td>
                <td>{{ polygon.epsg }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No polygons stored yet.</p>
    {% endif %}

    <hr>

    <h2>Upload new polygon CSV</h2>
    <form action="{{ url_for('polygons.upload_polygons') }}" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">Select CSV file:</label>
            <input type="file" name="file" class="form-control" accept=".csv" required>
        </div>
        <div class="form-group">
            <label for="epsg">Select EPSG coordinate system:</label>
            <select name="epsg" class="form-control" required>
                <option value="5514">S-JTSK / Krovak East North (EPSG:5514)</option>
                <option value="32633">WGS 84 / UTM zone 33N (EPSG:32633)</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Upload File</button>
    </form>

    <hr>

    <h2>Download all polygons</h2>
    <a href="{{ url_for('polygons.download_polygons') }}" class="btn btn-success">Download SHP</a>

</div>

<script>
function addRangeRow() {
  const container = document.getElementById('ranges-container');
  const row = document.createElement('div');
  row.className = 'row g-3 align-items-end range-row mt-2';
  row.innerHTML = `
    <div class="col-md-3">
      <label class="form-label">FROM</label>
      <input type="number" class="form-control" name="range_from[]" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">TO</label>
      <input type="number" class="form-control" name="range_to[]" required>
    </div>
    <div class="col-md-3">
      <button type="button" class="btn btn-outline-danger" onclick="this.closest('.range-row').remove()">Remove</button>
    </div>
  `;
  container.appendChild(row);
}
</script>
{% endblock %}