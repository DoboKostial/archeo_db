{% extends 'base.html' %}
{% block title %}Stratigraphic units{% endblock %}

{% block content %}
<div class="alert alert-info" role="alert">
  You are working on DB <strong>{{ selected_db }}</strong>.
  Next free SU ID is <strong>{{ suggested_id }}</strong>.
</div>

<div class="container mt-4">

  <!-- ===========================================================
       1) NEW STRATIGRAPHIC UNIT (3 columns)
       =========================================================== -->
  <fieldset class="border p-3 rounded-3 bg-primary-subtle">
    

    <!-- Title + help button aligned in one row -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h4 class="mb-0">New stratigraphic unit</h4>
      <button type="button"
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#helpNewSU"
              title="Help">
        ?
      </button>
    </div>

    <form method="POST" action="{{ url_for('su.add_su') }}">
      <div class="row g-3">

        <!-- Left: Basic info -->
        <div class="col-lg-4">
          <fieldset class="border p-3 rounded-3 bg-white">
            <legend class="w-auto px-2">Basic info</legend>

            <div class="mb-3">
              <label for="id_sj" class="form-label">SU ID</label>
              <input type="number" class="form-control" id="id_sj" name="id_sj"
                     value="{{ (form_data.id_sj if form_data else suggested_id) }}" required>
            </div>

            <div class="mb-3">
              <label for="sj_typ" class="form-label">SU type</label>
              <select class="form-select" id="sj_typ" name="sj_typ" required>
                {% set cur_typ = (form_data.sj_typ|lower if form_data and form_data.sj_typ else '') %}
                <option value="" {% if not cur_typ %}selected{% endif %}>-- choose --</option>
                <option value="deposit" {% if cur_typ == 'deposit' %}selected{% endif %}>Deposit</option>
                <option value="negativ" {% if cur_typ == 'negativ' %}selected{% endif %}>Negativ</option>
                <option value="structure" {% if cur_typ == 'structure' %}selected{% endif %}>Structure</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" name="description" rows="3">{{ form_data.description if form_data else "" }}</textarea>
            </div>

            <div class="mb-3">
              <label for="interpretation" class="form-label">Interpretation</label>
              <textarea class="form-control" id="interpretation" name="interpretation" rows="2">{{ form_data.interpretation if form_data else "" }}</textarea>
            </div>

            <div class="mb-3">
              <label for="author" class="form-label">Author (email)</label>
              <select class="form-select" id="author" name="author" required>
                <option value="">-- choose --</option>
                {% for a in authors %}
                  <option value="{{ a }}">{{ a }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="docu_plan" name="docu_plan"
                     {% if form_data and form_data.get('docu_plan') %}checked{% endif %}>
              <label class="form-check-label" for="docu_plan">Documentation: plan</label>
            </div>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="docu_vertical" name="docu_vertical"
                     {% if form_data and form_data.get('docu_vertical') %}checked{% endif %}>
              <label class="form-check-label" for="docu_vertical">Documentation: vertical</label>
            </div>

          </fieldset>
        </div>

        <!-- Middle: Type-specific + Polygons -->
        <div class="col-lg-4">
          <fieldset class="border p-3 rounded-3 bg-white mb-3">
            <legend class="w-auto px-2">Type-specific</legend>

            <!-- Deposit fields -->
            <div id="deposit_fields" class="sj-type-block">
              <div class="mb-2">
                <label class="form-label">Deposit type</label>
                <input type="text" class="form-control" name="deposit_typ" value="{{ form_data.deposit_typ if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Color</label>
                <input type="text" class="form-control" name="color" value="{{ form_data.color if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Boundary visibility</label>
                <input type="text" class="form-control" name="boundary_visibility" value="{{ form_data.boundary_visibility if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Structure</label>
                <input type="text" class="form-control" name="structure" value="{{ form_data.structure if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Compactness</label>
                <input type="text" class="form-control" name="compactness" value="{{ form_data.compactness if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Deposit removed</label>
                <input type="text" class="form-control" name="deposit_removed" value="{{ form_data.deposit_removed if form_data else '' }}">
              </div>
            </div>

            <!-- Negativ fields -->
            <div id="negativ_fields" class="sj-type-block">
              <div class="mb-2">
                <label class="form-label">Negativ type</label>
                <input type="text" class="form-control" name="negativ_typ" value="{{ form_data.negativ_typ if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Excavation extent</label>
                <input type="text" class="form-control" name="excav_extent" value="{{ form_data.excav_extent if form_data else '' }}">
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="ident_niveau_cut" name="ident_niveau_cut"
                       {% if form_data and form_data.get('ident_niveau_cut') %}checked{% endif %}>
                <label class="form-check-label" for="ident_niveau_cut">Ident. niveau cut</label>
              </div>
              <div class="mb-2">
                <label class="form-label">Shape plan</label>
                <input type="text" class="form-control" name="shape_plan" value="{{ form_data.shape_plan if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Shape sides</label>
                <input type="text" class="form-control" name="shape_sides" value="{{ form_data.shape_sides if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Shape bottom</label>
                <input type="text" class="form-control" name="shape_bottom" value="{{ form_data.shape_bottom if form_data else '' }}">
              </div>
            </div>

            <!-- Structure fields -->
            <div id="structure_fields" class="sj-type-block">
              <div class="mb-2">
                <label class="form-label">Structure type</label>
                <input type="text" class="form-control" name="structure_typ" value="{{ form_data.structure_typ if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Construction type</label>
                <input type="text" class="form-control" name="construction_typ" value="{{ form_data.construction_typ if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Binder</label>
                <input type="text" class="form-control" name="binder" value="{{ form_data.binder if form_data else '' }}">
              </div>
              <div class="mb-2">
                <label class="form-label">Basic material</label>
                <input type="text" class="form-control" name="basic_material" value="{{ form_data.basic_material if form_data else '' }}">
              </div>
              <div class="row g-2">
                <div class="col-md-4">
                  <label class="form-label">Length (m)</label>
                  <input type="number" step="0.01" class="form-control" name="length_m" value="{{ form_data.length_m if form_data else '' }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Width (m)</label>
                  <input type="number" step="0.01" class="form-control" name="width_m" value="{{ form_data.width_m if form_data else '' }}">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Height (m)</label>
                  <input type="number" step="0.01" class="form-control" name="height_m" value="{{ form_data.height_m if form_data else '' }}">
                </div>
              </div>
            </div>

          </fieldset>

          <!-- NEW: Polygons (M:N) -->
          <fieldset class="border p-3 rounded-3 bg-white">
            <legend class="w-auto px-2">Polygons</legend>

            <div class="mb-2 position-relative">
              <label class="form-label">Polygon</label>

              <!-- Input with dynamic suggestions -->
              <input id="polygonInput"
                    type="text"
                    class="form-control"
                    placeholder="Start typing polygon name..."
                    autocomplete="off">

              <!-- Suggestions dropdown (Bootstrap list-group) -->
              <div id="polygonSuggestions"
                  class="list-group position-absolute w-100 d-none"
                  style="z-index: 1000;"></div>

              <!-- Hidden source of polygon names for JS -->
              <datalist id="polygonDatalist">
                {% for p in polygons %}
                  <option value="{{ p }}"></option>
                {% endfor %}
              </datalist>

              <div class="form-text">Type and pick from suggestions, then click “Add”.</div>
            </div>

            <div class="d-flex gap-2">
              <button id="addPolygonBtn" type="button" class="btn btn-outline-primary">+ Add</button>
              <button id="clearPolygonsBtn" type="button" class="btn btn-outline-secondary">Clear</button>
            </div>

            <hr class="my-3">

            <div class="alert alert-light border py-2 mb-2">
              <span class="text-muted">Selected polygons:</span>
              <strong id="selectedPolygonsCount" class="ms-1">0</strong>
            </div>

            <div id="selectedPolygons" class="d-flex flex-wrap gap-2"></div>
            <div id="polygonHiddenInputs"></div>
          </fieldset>
        </div>

        <!-- Right: Stratigraphic relations -->
        <div class="col-lg-4">
          <fieldset class="border p-3 rounded-3 bg-white">
            <legend class="w-auto px-2">Stratigraphic relations</legend>


            <div class="mb-3">
              <label class="form-label">Below (SU IDs)</label>
              <div class="row g-2">
                <div class="col-6">
                  <input type="number" class="form-control" name="below_1" placeholder="ID" value="{{ form_data.below_1 if form_data else '' }}">
                </div>
                <div class="col-6">
                  <input type="number" class="form-control" name="below_2" placeholder="ID" value="{{ form_data.below_2 if form_data else '' }}">
                </div>
              </div>
            </div>


            <div class="mb-3">
              <label class="form-label">Equal (=)</label>
              <input type="number" class="form-control" name="equal" placeholder="ID" value="{{ form_data.equal if form_data else '' }}">
            </div>


            <div class="mb-3">
              <label class="form-label">Above (SU IDs)</label>
              <div class="row g-2">
                <div class="col-6">
                  <input type="number" class="form-control" name="above_1" placeholder="ID" value="{{ form_data.above_1 if form_data else '' }}">
                </div>
                <div class="col-6">
                  <input type="number" class="form-control" name="above_2" placeholder="ID" value="{{ form_data.above_2 if form_data else '' }}">
                </div>
              </div>
            </div>




            <small class="text-muted">
              Stored exactly as entered (>, <, =). There is no FK to tab_sj.
            </small>
          </fieldset>
        </div>

        <div class="col-12 text-center mt-2">
          <button type="submit" class="btn btn-primary btn-lg">Save SU</button>
        </div>

      </div>
    </form>
  </fieldset>


  <!-- ===========================================================
       2) SUS LIST (counts + last 10 + delete)
       =========================================================== -->
  <fieldset class="border p-3 rounded-3 bg-light mt-4">
    <legend class="w-auto px-2">SUs list</legend>

    <div class="row g-3 mb-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body py-3">
            <div class="text-muted small">Total</div>
            <div class="fs-4"><strong>{{ sj_count_total }}</strong></div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body py-3">
            <div class="text-muted small">Deposits</div>
            <div class="fs-4"><strong>{{ sj_count_deposit }}</strong></div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body py-3">
            <div class="text-muted small">Negatives</div>
            <div class="fs-4"><strong>{{ sj_count_negativ }}</strong></div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body py-3">
            <div class="text-muted small">Structures</div>
            <div class="fs-4"><strong>{{ sj_count_structure }}</strong></div>
          </div>
        </div>
      </div>
    </div>

    <h6 class="mb-2">Last 10 SUs</h6>

    {% if last_sus and last_sus|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
          <thead>
            <tr>
              <th class="text-end">ID</th>
              <th>Type</th>
              <th>Description</th>
              <th>Recorded</th>
              <th>Author</th>
              <th class="text-end">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for su in last_sus %}
              <tr>
                <td class="text-end"><strong>{{ su.id }}</strong></td>
                <td>{{ su.typ or '—' }}</td>
                <td title="{{ su.desc }}">{{ (su.desc[:120] ~ ('…' if su.desc|length > 120 else '')) if su.desc else '—' }}</td>
                <td>{{ su.recorded if su.recorded else '—' }}</td>
                <td>{{ su.author if su.author else '—' }}</td>
                <td class="text-end">
                  <button type="button"
                          class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteSuModal"
                          data-sj-id="{{ su.id }}">
                    Delete
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">No SUs stored yet.</p>
    {% endif %}
  </fieldset>


  <!-- ===========================================================
       3) ATTACH GRAPHIC DOCUMENTATION (selected existing SU)
       =========================================================== -->
  <fieldset class="border p-3 rounded-3 bg-success-subtle mt-4">
    <legend class="w-auto px-2">Attach graphic documentation</legend>

        <!-- SU selector (single input with dynamic suggestions) -->
        <div class="row g-2 align-items-end mb-3">
          <div class="col-12 position-relative">
            <label class="form-label">Select SU</label>

            <input id="suMediaInput"
                  type="text"
                  class="form-control"
                  placeholder="Start typing SU ID..."
                  autocomplete="off">

            <div id="suSuggestions"
                class="list-group position-absolute w-100 d-none"
                style="z-index: 1000;"></div>

            <!-- Hidden source for JS -->
            <datalist id="suDatalist">
              {% for su in su_for_media %}
                <option value="{{ su.id }}"
                        label="{{ su.id }}{% if su.typ %} ({{ su.typ }}){% endif %}{% if su.desc %} - {{ su.desc[:60] }}{% endif %}">
                </option>
              {% endfor %}
            </datalist>

            <div class="form-text">Pick an existing SU first — uploads will attach to it.</div>
          </div>

          <div class="col-12">
            <div class="alert alert-light border mb-0 py-2">
              <span class="text-muted">Selected:</span>
              <strong id="suMediaSelectedLabel" class="ms-1">—</strong>
            </div>
          </div>
        </div>


    <!-- action buttons -->
    <div class="d-flex gap-2 flex-wrap">
      <button type="button" class="btn btn-primary suDocBtn" data-bs-toggle="modal" data-bs-target="#modalPhotos">
        Upload photos
      </button>
      <button type="button" class="btn btn-secondary suDocBtn" data-bs-toggle="modal" data-bs-target="#modalSketches">
        Upload sketches
      </button>
      <button type="button" class="btn btn-info suDocBtn" data-bs-toggle="modal" data-bs-target="#modalDrawings">
        Upload drawings
      </button>
      <button type="button" class="btn btn-warning suDocBtn" data-bs-toggle="modal" data-bs-target="#modalPhotograms">
        Upload photograms
      </button>
    </div>

    <small class="text-muted d-block mt-2">Allowed: .jpeg .jpg .png .tiff .svg .pdf</small>
  </fieldset>

</div>


<!-- ===========================================================
     DELETE SU MODAL
     =========================================================== -->
<div class="modal fade" id="deleteSuModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('su.delete_su') }}" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete SU</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id_sj" id="deleteSuIdHidden" value="">
        <p class="mb-0">
          Are you sure you want to delete SU <strong id="deleteSuIdPreview">—</strong>?
        </p>
        <small class="text-muted">
          Stratigraphy relations and links should be removed by FK cascades (per your DDL change).
        </small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger">Delete</button>
      </div>
    </form>
  </div>
</div>


<!-- ===========================================================
     MEDIA MODALS (Attach to selected SU)
     =========================================================== -->

<!-- Photos modal -->
<div class="modal fade" id="modalPhotos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formPhotos" method="post" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload photos to SU</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="filesPhotos" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2" accept=".jpeg,jpg,png,tiff,svg,pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesPhotos')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Photo type</label>
            <input type="text" name="photo_typ" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" name="datum" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Author (email)</label>
            <input type="email" name="author" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">SU ID: <span id="suIdPreviewPhotos"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>


<!-- Sketches modal -->
<div class="modal fade" id="modalSketches" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formSketches" method="post" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload sketches to SU</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="filesSketches" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2" accept=".jpeg,jpg,png,tiff,svg,pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesSketches')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Sketch type</label>
            <input type="text" name="sketch_typ" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Author (email)</label>
            <input type="email" name="author" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Date (optional)</label>
            <input type="date" name="datum" class="form-control">
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">SU ID: <span id="suIdPreviewSketches"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>


<!-- Drawings modal -->
<div class="modal fade" id="modalDrawings" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formDrawings" method="post" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload drawings to SU</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="filesDrawings" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2" accept=".jpeg,jpg,png,tiff,svg,pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesDrawings')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Author (email)</label>
            <input type="email" name="author" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" name="datum" class="form-control" required>
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">SU ID: <span id="suIdPreviewDrawings"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>


<!-- Photograms modal -->
<div class="modal fade" id="modalPhotograms" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="formPhotograms" method="post" enctype="multipart/form-data" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload photograms to SU</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="filesPhotograms" class="mb-3">
          <label class="form-label">Files</label>
          <input type="file" name="files" class="form-control mb-2" accept=".jpeg,jpg,png,tiff,svg,pdf" multiple>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesPhotograms')">+ add files input</button>

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Photogram type</label>
            <input type="text" name="photogram_typ" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Ref. sketch (optional)</label>
            <input type="text" name="ref_sketch" class="form-control" placeholder="id_sketch">
          </div>
          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" name="notes" class="form-control">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <span class="text-muted me-auto">SU ID: <span id="suIdPreviewPhotograms"></span></span>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Upload</button>
      </div>
    </form>
  </div>
</div>


<!-- HELP MODAL: New stratigraphic unit -->
<div class="modal fade" id="helpNewSU" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Help: New stratigraphic unit</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        {% include "help/su_help.html" %}
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>



<!-- External JS -->
<script src="{{ url_for('static', filename='js/su.js') }}"></script>
{% endblock %}
