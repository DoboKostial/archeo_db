{% extends 'base.html' %}
{% block title %}New stratigraphic unit{% endblock %}


{% block content %}
<div class="alert alert-info" role="alert">
    You are working on DB <strong>{{ selected_db }}</strong>. Next free SU ID is <strong>{{ suggested_id }}</strong>.
</div>
<div class="container mt-4">
    <h3>New startigraphic unit</h3>
    <form method="POST">
        <div class="container">
            <div class="row mb-4">
                <!-- A. SU basix info -->
                <div class="col-md-6">
                    <fieldset class="border p-3 bg-light">
                        <legend class="w-auto px-2">A. Basic description</legend>
    
                        <div class="mb-3">
                            <label for="id_sj" class="form-label">ID SJ</label>
                            <input type="number" class="form-control" id="id_sj" name="id_sj" value="{{ suggested_id }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="sj_typ" class="form-label">SU type</label>
                            <select class="form-select" id="sj_typ" name="sj_typ" required onchange="toggleFields()">
                                <option value="">-- choose --</option>
                                <option value="deposit">Deposit</option>
                                <option value="negativ">Negativ</option>
                                <option value="structure">Structure</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="interpretation" class="form-label">Interpretation</label>
                            <textarea class="form-control" id="interpretation" name="interpretation" rows="3"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="docu_plan" name="docu_plan">
                            <label class="form-check-label" for="docu_plan">Documentation – plan</label>
                        </div>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="docu_vertical" name="docu_vertical">
                            <label class="form-check-label" for="docu_vertical">Dokumentation – cut</label>
                        </div>
                        <div class="mb-3">
                            <label for="author" class="form-label">Author</label>
                            <select class="form-select" id="author" name="author" required>
                                {% for email in authors %}
                                    <option value="{{ email }}">{{ email }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </fieldset>
                </div>
    
                <!-- B. Attributes depending on SU type -->
                <div class="col-md-6">
                    <fieldset class="border p-3 bg-warning-subtle">
                        <legend class="w-auto px-2">B. Attributes depending on SU type</legend>
    
                        <!-- DEPOSIT -->
                        <div id="deposit_fields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Deposit type</label>
                                <input type="text" class="form-control" name="deposit_typ">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" name="color">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Boundary visibility</label>
                                <input type="text" class="form-control" name="boundary_visibility">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Composition</label>
                                <input type="text" class="form-control" name="structure">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Compactness</label>
                                <input type="text" class="form-control" name="compactness">
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="deposit_removed" name="deposit_removed">
                                <label class="form-check-label" for="deposit_removed">Deposit was completely removed</label>
                            </div>
                        </div>
    
                        <!-- NEGATIV -->
                        <div id="negativ_fields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Negative type</label>
                                <input type="text" class="form-control" name="negativ_typ">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Extent of exposure</label>
                                <input type="text" class="form-control" name="excav_extent">
                            </div>
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="ident_niveau_cut" name="ident_niveau_cut">
                                <label class="form-check-label" for="ident_niveau_cut">Cut niveau identification</label>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Plan shape</label>
                                <input type="text" class="form-control" name="shape_plan">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Walls shape</label>
                                <input type="text" class="form-control" name="shape_sides">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bottom shape</label>
                                <input type="text" class="form-control" name="shape_bottom">
                            </div>
                        </div>
    
                        <!-- STRUCTURE -->
                        <div id="structure_fields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Structure type</label>
                                <input type="text" class="form-control" name="structure_typ">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Construction type</label>
                                <input type="text" class="form-control" name="construction_typ">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Binder</label>
                                <input type="text" class="form-control" name="binder">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Basic material</label>
                                <input type="text" class="form-control" name="basic_material">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lenght (m)</label>
                                <input type="number" step="0.1" class="form-control" name="length_m">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Width (m)</label>
                                <input type="number" step="0.1" class="form-control" name="width_m">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Height (m)</label>
                                <input type="number" step="0.1" class="form-control" name="height_m">
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
    
            <div class="row mb-4">
                <!-- C. STARTIGRAPHY -->
                <div class="col-md-6">
                    <fieldset class="border p-3 bg-info-subtle">
                        <legend class="w-auto px-2">C. Stratigraphic relations</legend>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <small>Enter the SU numbers that are related to this SU:</small>
                            </div>
                  

                            <!-- LAYING UNDER -->
                            <div class="col-md-6 mb-3">
                                <label for="below_1" class="form-label">Lies under (SU #1):</label>
                                <input type="number" class="form-control" id="below_1" name="below_1" placeholder="e.g. 44">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="below_2" class="form-label">Lies under (SU #2):</label>
                                <input type="number" class="form-control" id="below_2" name="below_2" placeholder="e.g. 45">
                            </div>

                            <!-- CONTEMPORARY -->
                            <div class="col-md-12 mb-3">
                                <label for="equal" class="form-label">Contemporary with: (SU):</label>
                                <input type="number" class="form-control" id="equal" name="equal" placeholder="e.g. 46">
                            </div> 



                            <!-- LAYING ABOVE -->
                            <div class="col-md-6 mb-3">
                                <label for="above_1" class="form-label">Lies above (SU #1):</label>
                                <input type="number" class="form-control" id="above_1" name="above_1" placeholder="e.g. 42">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="above_2" class="form-label">Lies above (SU #2):</label>
                                <input type="number" class="form-control" id="above_2" name="above_2" placeholder="e.g. 43">
                            </div>
                


                        </div>
                    </fieldset>
                </div>
    
                <!-- D. OVERVIEW -->
                <div class="col-md-6">
                    <fieldset class="border p-3 bg-light">
                    <legend class="w-auto px-2">D. Overview of SUs in database "{{ selected_db }}"</legend>
                    <ul class="list-unstyled">
                        <li>Total stratigraphic units: <strong>{{ sj_count_total }}</strong></li>
                        <li>Deposits: <strong>{{ sj_count_deposit }}</strong></li>
                        <li>Negatives: <strong>{{ sj_count_negative }}</strong></li>
                        <li>Structures: <strong>{{ sj_count_structure }}</strong></li>
                    </ul>
                    </fieldset>
                </div>
    
            <div class="text-center mb-5">
                <button type="submit" class="btn btn-primary btn-lg">Save SU</button>
            </div>
        </div>
    </form>
    
    
</div>



<!-- ========= G. GRAPHIC DOCUMENTATION (Uploads) ========= -->
<div class="container mt-4">
    <fieldset class="border p-3 bg-success-subtle">
      <legend class="w-auto px-2">G. Graphic documentation</legend>
      <div class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-primary"   data-bs-toggle="modal" data-bs-target="#modalPhotos">Upload photos</button>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalSketches">Upload sketches</button>
        <button type="button" class="btn btn-info"      data-bs-toggle="modal" data-bs-target="#modalDrawings">Upload drawings</button>
        <button type="button" class="btn btn-warning"   data-bs-toggle="modal" data-bs-target="#modalPhotograms">Upload photograms</button>
      </div>
      <small class="text-muted d-block mt-2">Allowed: .jpeg .jpg .png .tiff .svg .pdf</small>
    </fieldset>
  </div>
  
  <!-- ====== Photos modal ====== -->
  <div class="modal fade" id="modalPhotos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formPhotos" method="post" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload photos to SU</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="dbname" value="{{ selected_db }}">
  
          <div id="filesPhotos" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2" accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesPhotos')">+ add files input</button>
  
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Photo type</label>
              <input type="text" name="photo_typ" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Date</label>
              <input type="date" name="datum" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Author (email)</label>
              <input type="email" name="author" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <span class="text-muted me-auto">SU ID: <span id="suIdPreviewPhotos"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ====== Sketches modal ====== -->
  <div class="modal fade" id="modalSketches" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formSketches" method="post" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload sketches to SU</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="dbname" value="{{ selected_db }}">
  
          <div id="filesSketches" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2" accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesSketches')">+ add files input</button>
  
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Sketch type</label>
              <input type="text" name="sketch_typ" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Author (email)</label>
              <input type="email" name="author" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Date (optional)</label>
              <input type="date" name="datum" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <span class="text-muted me-auto">SU ID: <span id="suIdPreviewSketches"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ====== Drawings modal ====== -->
  <div class="modal fade" id="modalDrawings" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formDrawings" method="post" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload drawings to SU</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="dbname" value="{{ selected_db }}">
  
          <div id="filesDrawings" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2" accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesDrawings')">+ add files input</button>
  
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Author (email)</label>
              <input type="email" name="author" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date</label>
              <input type="date" name="datum" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <span class="text-muted me-auto">SU ID: <span id="suIdPreviewDrawings"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- ====== Photograms modal ====== -->
  <div class="modal fade" id="modalPhotograms" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="formPhotograms" method="post" enctype="multipart/form-data" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Upload photograms to SU</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="dbname" value="{{ selected_db }}">
  
          <div id="filesPhotograms" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2" accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="addFileInput('filesPhotograms')">+ add files input</button>
  
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Photogram type</label>
              <input type="text" name="photogram_typ" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ref. sketch (optional)</label>
              <input type="text" name="ref_sketch" class="form-control" placeholder="id_sketch">
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <span class="text-muted me-auto">SU ID: <span id="suIdPreviewPhotograms"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
  // Dynamic addition next item <input type="file">
  function addFileInput(containerId) {
    const c = document.getElementById(containerId);
    const input = document.createElement('input');
    input.type = 'file';
    input.name = 'files';
    input.className = 'form-control mb-2';
    input.setAttribute('accept', '.jpeg,.jpg,.png,.tiff,.svg,.pdf');
    c.appendChild(input);
  }
  
  // Helper function: get actual SU ID from main form field 
  function currentSuId() {
    const el = document.getElementById('id_sj');
    return el && el.value ? el.value : '';
  }
  
  // Setting right action with actual SU ID before sending
  function hookUploadForm(formId, mediaType, suPreviewSpanId) {
    const form = document.getElementById(formId);
    form.addEventListener('submit', function(ev) {
      const sj = currentSuId();
      if (!sj) {
        ev.preventDefault();
        alert('Please fill in SU ID first.');
        return false;
      }
      form.action = `/su/${encodeURIComponent(sj)}/upload/${mediaType}`;
    });
  
    // when modal window opens, show SU ID
    const suSpan = document.getElementById(suPreviewSpanId);
    document.getElementById(formId).closest('.modal').addEventListener('show.bs.modal', function() {
      if (suSpan) suSpan.textContent = currentSuId() || '—';
    });
  }
  
  // linking all 4 forms
  hookUploadForm('formPhotos',     'photos',     'suIdPreviewPhotos');
  hookUploadForm('formSketches',   'sketches',   'suIdPreviewSketches');
  hookUploadForm('formDrawings',   'drawings',   'suIdPreviewDrawings');
  hookUploadForm('formPhotograms', 'photograms', 'suIdPreviewPhotograms');
  </script>
  





<script>

function toggleFields() {
        const sjTyp = document.getElementById("sj_typ").value;

        document.getElementById("deposit_fields").style.display = (sjTyp === "deposit") ? "block" : "none";
        document.getElementById("negativ_fields").style.display = (sjTyp === "negativ") ? "block" : "none";
        document.getElementById("structure_fields").style.display = (sjTyp === "structure") ? "block" : "none";
    }

    window.onload = toggleFields;


</script>
{% endblock %}
