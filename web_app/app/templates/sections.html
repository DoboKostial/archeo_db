{# app/templates/sections.html #}
{% extends "base.html" %}
{% block title %}Sections{% endblock %}

{% block content %}
<div class="alert alert-info" role="alert">
  You are working with database <strong>{{ selected_db }}</strong>.
</div>

<div class="container mt-3">

  <!-- Row 1: Manual create (two-column form) -->
  <form method="POST" action="{{ url_for('sections.new_section_manual') }}">
    <div class="row g-3">

      <!-- Left: Section metadata + ranges -->
      <div class="col-md-7">
        <div class="p-3 rounded-3 border bg-light">
          <h4 class="mb-3">Define sections manually (with geopoints)</h4>
          <button type="button"
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#helpSectionDefinition"
              title="Help">
            ?
          </button>

          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Section ID</label>
              <input type="number" class="form-control" name="id_section" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Section type</label>
              <select name="section_type" class="form-select" required>
                <option value="" selected disabled>-- select --</option>
                <option value="standard">standard</option>
                <option value="cumulative">cumulative</option>
                <option value="synthetic">synthetic</option>
                <option value="other">other</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Description</label>
              <input type="text" class="form-control" name="description" placeholder="optional">
            </div>
          </div>

          <!-- Point ranges -->
          <div class="mt-3">
            <div class="d-flex align-items-center mb-2">
              <h6 class="mb-0 me-2">Point ranges (FROM–TO)</h6>
              <small class="text-muted">(tab_geopts id_pts; line is built ascending by points)</small>
            </div>

            <div id="ranges-container">
              <div class="row g-2 align-items-end range-row">
                <div class="col-5">
                  <label class="form-label">FROM</label>
                  <input type="number" class="form-control" name="range_from[]">
                </div>
                <div class="col-5">
                  <label class="form-label">TO</label>
                  <input type="number" class="form-control" name="range_to[]">
                </div>
                <div class="col-2">
                  <button type="button" class="btn btn-outline-secondary mt-4" onclick="addRangeRow()">+</button>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-3">
            <button type="submit" class="btn btn-primary">Save</button>
          </div>

        </div>
      </div>

      <!-- Right: Bind SUs (moved here to save vertical space) -->
      <div class="col-md-5">
        <div class="p-3 rounded-3 border">
          <h5 class="mb-2">Select cut stratigraphic units</h5>
          <select class="form-select" name="ref_sj[]" multiple size="14">
            {% for sj in sj_ids %}
              <option value="{{ sj }}">{{ sj }}</option>
            {% endfor %}
          </select>
          <small class="text-muted">Hold Shift/Ctrl/⌘ to select multiple.</small>
        </div>
      </div>

    </div>
  </form>

  <!-- JS: add/remove range rows -->
  <script>
    function addRangeRow() {
      const container = document.getElementById('ranges-container');
      const row = document.createElement('div');
      row.className = 'row g-2 align-items-end range-row mt-2';
      row.innerHTML = `
        <div class="col-5">
          <label class="form-label">FROM</label>
          <input type="number" class="form-control" name="range_from[]">
        </div>
        <div class="col-5">
          <label class="form-label">TO</label>
          <input type="number" class="form-control" name="range_to[]">
        </div>
        <div class="col-2 d-flex gap-1">
          <button type="button" class="btn btn-outline-secondary mt-4" onclick="addRangeRow()">+</button>
          <button type="button" class="btn btn-outline-danger mt-4" onclick="removeRangeRow(this)">−</button>
        </div>
      `;
      container.appendChild(row);
    }
    function removeRangeRow(btn) {
      const row = btn.closest('.range-row');
      if (row) row.remove();
    }
  </script>

    <!-- Row 2: Existing sections list + GLOBAL actions -->
  <div class="row g-3 mt-3">
    <div class="col-12">
      <div class="p-3 rounded-3 border">

        <!-- Header + global buttons -->
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h4 class="mb-0">Existing sections</h4>

          <div class="d-flex gap-2 flex-wrap">
            <form method="POST" action="{{ url_for('sections.rebuild_all_sections') }}" class="m-0">
              <button type="submit" class="btn btn-sm btn-outline-primary">
                Rebuild geometry
              </button>
            </form>

            <a class="btn btn-sm btn-outline-success"
               href="{{ url_for('sections.download_sections') }}">
              Export SHP
            </a>
          </div>
        </div>

        {% if sections and sections|length %}
          <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle mb-0 w-100">
              <thead class="table-light">
                <tr>
                  <th style="width:90px;">ID</th>
                  <th style="width:140px;">Type</th>
                  <th>Description</th>
                  <th class="text-end" style="width:150px;">POINT RANGES</th>
                  <th class="text-end" style="width:200px;">NUMBER OF SU CUT</th>
                  <th class="text-end" style="width:100px;">DELETE</th>
                </tr>
              </thead>
              <tbody>
                {% for s in sections %}
                <tr>
                  <td>{{ s.id }}</td>
                  <td>{{ s.type }}</td>
                  <td class="text-break">{{ s.description }}</td>
                  <td class="text-end">{{ s.ranges_nr }}</td>
                  <td class="text-end">{{ s.sj_nr }}</td>

                  <td class="text-end">
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteSectionModal"
                            data-id-section="{{ s.id }}">
                      Delete
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No sections stored yet.</p>
        {% endif %}
      </div>
    </div>
  </div>


  <!-- Row 3: Graphic documentation -->
  <div class="container mt-4">
    <fieldset class="border p-3 bg-success-subtle">
      <legend class="w-auto px-2">Graphic documentation</legend>

      <!-- Authors datalist -->
      <datalist id="authors-list">
        {% for a in authors %}
          <option value="{{ a }}"></option>
        {% endfor %}
      </datalist>

      <div class="row g-2 align-items-end mb-3">
        <div class="col-md-6">
          <label class="form-label">Select section</label>
          <select id="secDocSelect" class="form-select">
            <option value="" selected>-- select section --</option>
            {% for s in sections %}
              <option value="{{ s.id }}">{{ s.id }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <div class="alert alert-light border mb-0 py-2">
            <span class="text-muted">Selected:</span>
            <strong id="secDocSelectedLabel" class="ms-1">—</strong>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2 flex-wrap">
        <button type="button" class="btn btn-primary secDocBtn"
                data-bs-toggle="modal" data-bs-target="#modalSecPhotos">
          Upload photos
        </button>
        <button type="button" class="btn btn-secondary secDocBtn"
                data-bs-toggle="modal" data-bs-target="#modalSecSketches">
          Upload sketches
        </button>
        <button type="button" class="btn btn-warning secDocBtn"
                data-bs-toggle="modal" data-bs-target="#modalSecPhotograms">
          Upload photograms
        </button>
        <button type="button" class="btn btn-dark secDocBtn"
                data-bs-toggle="modal" data-bs-target="#modalSecDrawings">
          Upload drawings
        </button>
      </div>

      <small class="text-muted d-block mt-2">Allowed: .jpeg .jpg .png .tiff .svg .pdf</small>
    </fieldset>
  </div>

  <!-- Photos modal -->
  <div class="modal fade" id="modalSecPhotos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form class="modal-content secDocForm"
            method="post"
            action="{{ url_for('sections.upload_section_media', media_type='photos') }}"
            enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload photos to section</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id_section" class="secDocHidden" value="">

          <div id="filesSecPhotos" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2"
                   accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                  onclick="addFileInput('filesSecPhotos')">+ add files input</button>

          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Photo type *</label>
              <input type="text" name="photo_typ" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Date *</label>
              <input type="date" name="datum" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Author (email) *</label>
              <input type="email" name="author" class="form-control" list="authors-list" required>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <span class="text-muted me-auto">Section: <span class="secDocPreview"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Sketches modal -->
  <div class="modal fade" id="modalSecSketches" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form class="modal-content secDocForm"
            method="post"
            action="{{ url_for('sections.upload_section_media', media_type='sketches') }}"
            enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload sketches to section</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id_section" class="secDocHidden" value="">

          <div id="filesSecSketches" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2"
                   accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                  onclick="addFileInput('filesSecSketches')">+ add files input</button>

          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Sketch type *</label>
              <input type="text" name="sketch_typ" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Author (email) *</label>
              <input type="email" name="author" class="form-control" list="authors-list" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Date</label>
              <input type="date" name="datum" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <span class="text-muted me-auto">Section: <span class="secDocPreview"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Photograms modal -->
  <div class="modal fade" id="modalSecPhotograms" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form class="modal-content secDocForm"
            method="post"
            action="{{ url_for('sections.upload_section_media', media_type='photograms') }}"
            enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload photograms to section</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id_section" class="secDocHidden" value="">

          <div id="filesSecPhotograms" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2"
                   accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                  onclick="addFileInput('filesSecPhotograms')">+ add files input</button>

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Photogram type *</label>
              <input type="text" name="photogram_typ" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ref sketch (optional)</label>
              <input type="text" name="ref_sketch" class="form-control" placeholder="id_sketch">
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <span class="text-muted me-auto">Section: <span class="secDocPreview"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Drawings modal -->
  <div class="modal fade" id="modalSecDrawings" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form class="modal-content secDocForm"
            method="post"
            action="{{ url_for('sections.upload_section_media', media_type='drawings') }}"
            enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title">Upload drawings to section</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id_section" class="secDocHidden" value="">

          <div id="filesSecDrawings" class="mb-3">
            <label class="form-label">Files</label>
            <input type="file" name="files" class="form-control mb-2"
                   accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf" multiple>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary mb-3"
                  onclick="addFileInput('filesSecDrawings')">+ add files input</button>

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Author (email) *</label>
              <input type="email" name="author" class="form-control" list="authors-list" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Date *</label>
              <input type="date" name="datum" class="form-control" required>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <input type="text" name="notes" class="form-control">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <span class="text-muted me-auto">Section: <span class="secDocPreview"></span></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Upload</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JS: file inputs + selected section propagation -->
  <script>
    function addFileInput(containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;

      const inp = document.createElement('input');
      inp.type = 'file';
      inp.name = 'files';
      inp.className = 'form-control mb-2';
      inp.multiple = true;
      inp.accept = '.jpeg,.jpg,.png,.tiff,.svg,.pdf';
      container.appendChild(inp);
    }

    (function () {
      const sel = document.getElementById('secDocSelect');
      const label = document.getElementById('secDocSelectedLabel');

      const hiddenInputs = document.querySelectorAll('.secDocHidden');
      const previews = document.querySelectorAll('.secDocPreview');
      const modalButtons = document.querySelectorAll('.secDocBtn');

      function applySection() {
        const val = (sel.value || '').trim();
        label.textContent = val ? val : '—';
        hiddenInputs.forEach(i => i.value = val);
        previews.forEach(p => p.textContent = val ? val : '—');
        modalButtons.forEach(b => b.disabled = !val);
      }

      sel.addEventListener('change', applySection);
      applySection();

      document.querySelectorAll('.secDocForm').forEach(form => {
        form.addEventListener('submit', (e) => {
          const v = form.querySelector('.secDocHidden')?.value?.trim();
          if (!v) {
            e.preventDefault();
            alert('Please select a section first.');
          }
        });
      });
    })();
  </script>

  <!-- Delete confirm modal -->
  <div class="modal fade" id="deleteSectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete section</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form method="POST" action="{{ url_for('sections.delete_section') }}">
          <div class="modal-body">
            <input type="hidden" name="id_section" id="deleteSectionId">
            <p class="mb-0">
              Do you really want to delete section <strong id="deleteSectionLabel"></strong>?
            </p>
            <small class="text-muted">All bindings and linked media will be deleted by cascade.</small>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const delSecModal = document.getElementById('deleteSectionModal');
    delSecModal.addEventListener('shown.bs.modal', (event) => {
      const btn = event.relatedTarget;
      const id = btn.getAttribute('data-id-section') || '';
      document.getElementById('deleteSectionId').value = id;
      document.getElementById('deleteSectionLabel').textContent = id;
    });
  </script>

</div>

<!-- ==== HERE MODALS FOR HELP IN WEB INTERFACE -->
<!-- Help modal: Section help -->
<div class="modal fade" id="helpSectionDefinition" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Help: Section manual definition</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% include "help/sections_manual_help.html" %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



{% endblock %}
