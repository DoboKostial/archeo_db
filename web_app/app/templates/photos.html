{# templates/photos.html #}
{% extends "base.html" %}
{% block title %}Photos{% endblock %}

{% block content %}
<div class="alert alert-info" role="alert">
  You are working with database <strong>{{ selected_db }}</strong>.
</div>

<div class="container mt-3">

<!-- SECTION 1: UPLOAD (subtle background) -->
<div class="p-3 rounded-3 border bg-body-tertiary mb-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0 d-flex align-items-center gap-2">
      Upload photos
      <button type="button"
              class="btn btn-sm btn-outline-secondary"
              data-bs-toggle="modal"
              data-bs-target="#helpPhotossUpload"
              title="Help">
        ?
      </button>
    </h4>
  </div>

  <form method="post"
        action="{{ url_for('photos.upload_photos') }}"
        enctype="multipart/form-data"
        id="photosUploadForm">

    <div class="border rounded-3 p-3 bg-white shadow-sm">
      <div class="row g-3">

        <!-- LEFT BOX: Direct photo attributes -->
        <div class="col-lg-6">
          <div class="border rounded-3 p-3 bg-light h-100">
            <div class="fw-semibold mb-2">Photo metadata</div>

            <!-- FILES -->
            <div class="mb-2">
              <label class="form-label">Files</label>

              <div class="input-group mb-2">
                <input type="file"
                       class="form-control"
                       name="files"
                       accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf"
                       required>
                <button type="button" class="btn btn-outline-secondary" id="btnAddFile">+ add more</button>
              </div>

              <div id="extraFiles"></div>

              <div class="form-text">Unique filename + unique content per project.</div>
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Photo type</label>
                <select class="form-select" name="photo_typ" required>
                  <option value="" selected disabled>-- select --</option>
                  {% for t in photo_typ_choices %}
                    <option value="{{ t }}">{{ t }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" name="datum" required>
              </div>

              <div class="col-12">
                <label class="form-label">Author (email)</label>
                <div class="search-select"
                     data-mode="single"
                     data-endpoint="{{ url_for('photos.api_search_authors') }}"
                     data-hidden-name="author"
                     data-placeholder="Type to search author...">
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Notes</label>
                <input type="text" class="form-control" name="notes" placeholder="optional">
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT BOX: Links to terrain entities -->
        <div class="col-lg-6">
          <div class="border rounded-3 p-3 bg-white h-100">
            <div class="fw-semibold mb-2">
              Links to terrain entities <span class="text-muted fw-normal">(optional, multi)</span>
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">SUs</label>
                <div class="search-select"
                     data-mode="multi"
                     data-endpoint="{{ url_for('photos.api_search_sj') }}"
                     data-hidden-name="ref_sj"
                     data-placeholder="Type to search SU...">
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Polygons</label>
                <div class="search-select"
                     data-mode="multi"
                     data-endpoint="{{ url_for('photos.api_search_polygons') }}"
                     data-hidden-name="ref_polygon"
                     data-placeholder="Type to search polygon...">
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Sections</label>
                <div class="search-select"
                     data-mode="multi"
                     data-endpoint="{{ url_for('photos.api_search_sections') }}"
                     data-hidden-name="ref_section"
                     data-placeholder="Type to search section...">
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Finds</label>
                <div class="search-select"
                     data-mode="multi"
                     data-endpoint="{{ url_for('photos.api_search_finds') }}"
                     data-hidden-name="ref_find"
                     data-placeholder="Type to search find...">
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">Samples</label>
                <div class="search-select"
                     data-mode="multi"
                     data-endpoint="{{ url_for('photos.api_search_samples') }}"
                     data-hidden-name="ref_sample"
                     data-placeholder="Type to search sample...">
                </div>
              </div>
            </div>

            <div class="form-text mt-2">
              One photo can be linked to multiple entities of the same type.
            </div>
          </div>
        </div>

      </div>

      <div class="mt-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary">Upload</button>
        <button type="reset" class="btn btn-outline-secondary">Reset</button>
      </div>

    </div>
  </form>
</div>


  <!-- SECTION 2: GALLERY + BULK (clean background) -->
  <div class="p-3 rounded-3 border bg-white mb-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h4 class="mb-0">Photos gallery</h4>
      <small class="text-muted">Showing {{ photos|length }} (filtered total: {{ filtered_cnt }})</small>
    </div>

    <!-- Bulk toolbar (UNCHANGED logic) -->
    <form method="post" action="{{ url_for('photos.bulk_photos') }}" id="bulkForm" class="mb-3">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnSelectAll">Select all</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnClearSelection">Clear</button>

        <select class="form-select form-select-sm" name="action" style="width: 200px;" required>
          <option value="" selected disabled>-- bulk action --</option>
          <option value="add_links">Add links</option>
          <option value="remove_links">Remove links</option>
        </select>

        <div class="search-select"
             data-mode="multi"
             data-endpoint="{{ url_for('photos.api_search_sj') }}"
             data-hidden-name="ref_sj"
             data-placeholder="Bulk: SU">
        </div>

        <div class="search-select"
             data-mode="multi"
             data-endpoint="{{ url_for('photos.api_search_polygons') }}"
             data-hidden-name="ref_polygon"
             data-placeholder="Bulk: Polygon">
        </div>

        <div class="search-select"
             data-mode="multi"
             data-endpoint="{{ url_for('photos.api_search_sections') }}"
             data-hidden-name="ref_section"
             data-placeholder="Bulk: Section">
        </div>

        <div class="search-select"
             data-mode="multi"
             data-endpoint="{{ url_for('photos.api_search_finds') }}"
             data-hidden-name="ref_find"
             data-placeholder="Bulk: Find">
        </div>

        <div class="search-select"
             data-mode="multi"
             data-endpoint="{{ url_for('photos.api_search_samples') }}"
             data-hidden-name="ref_sample"
             data-placeholder="Bulk: Sample">
        </div>

        <button type="submit" class="btn btn-sm btn-primary">Apply</button>
      </div>
      <div id="bulkSelectedContainer"></div>
    </form>

    <!-- Gallery grid (UNCHANGED) -->
    <div class="row g-3">
      {% for p in photos %}
      <div class="col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100 shadow-sm">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div class="form-check m-0">
              <input class="form-check-input photo-check" type="checkbox" value="{{ p.id_photo }}">
            </div>
            <span class="small text-muted">{{ p.datum }}</span>
          </div>

          <a href="{{ url_for('photos.serve_photo_file', id_photo=p.id_photo) }}" target="_blank">
            <img class="card-img-top"
                 src="{{ url_for('photos.serve_photo_thumb', id_photo=p.id_photo) }}"
                 onerror="this.style.display='none'; this.parentElement.insertAdjacentHTML('beforeend','<div class=&quot;p-3 text-muted small&quot;>No thumbnail</div>');"
                 alt="{{ p.id_photo }}">
          </a>

          <div class="card-body">
            <div class="small text-muted mb-1">{{ p.id_photo }}</div>
            <div class="d-flex flex-wrap gap-1 mb-2">
              <span class="badge text-bg-secondary">{{ p.photo_typ }}</span>
              {% if p.gps_lat and p.gps_lon %}
                <span class="badge text-bg-success">GPS</span>
              {% else %}
                <span class="badge text-bg-light">no GPS</span>
              {% endif %}
              <span class="badge text-bg-light">
                Links:
                SUs ({{ p.link_counts.sj }}),
                Polygons ({{ p.link_counts.polygon }}),
                Sections ({{ p.link_counts.section }})<br>
                Finds ({{ p.link_counts.find }}),
                Samples ({{ p.link_counts.sample }})
              </span>
            </div>
            {% if p.notes %}
              <div class="small">{{ p.notes }}</div>
            {% endif %}
          </div>

          <div class="card-footer d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary btnEdit"
                    data-id="{{ p.id_photo }}">Edit</button>

            <button type="button" class="btn btn-sm btn-outline-danger btnDelete"
                    data-id="{{ p.id_photo }}">Delete</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination (UNCHANGED) -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted small">Page {{ page }}</div>
      <div class="d-flex gap-2">
        {% if page > 1 %}
          <a class="btn btn-sm btn-outline-secondary"
             href="{{ url_for('photos.photos', page=page-1, per_page=per_page) }}">Prev</a>
        {% endif %}
        <a class="btn btn-sm btn-outline-secondary"
           href="{{ url_for('photos.photos', page=page+1, per_page=per_page) }}">Next</a>
      </div>
    </div>
  </div>

  <!-- SECTION 3: STATS + FILTER (different subtle background) -->
  <div class="p-3 rounded-3 border bg-light mb-3">
    <h4 class="mb-3">Stats & filter</h4>

    <div class="row g-3">
      <!-- LEFT: overview -->
      <div class="col-lg-4">
        <div class="p-3 border rounded-3 bg-white h-100 shadow-sm">
          <div class="text-muted small">Total photos</div>
          <div class="fs-4">{{ stats.total_cnt }}</div>
          <div class="text-muted small">Total size: {{ stats.total_bytes_h }}</div>
          <div class="text-muted small">Orphans (no links): {{ stats.orphan_cnt }}</div>

          <hr class="my-3">

          <div class="text-muted small mb-2">By photo type</div>
          <div class="d-flex flex-wrap gap-2">
            {% for t, c in stats.by_type %}
              <span class="badge text-bg-secondary">{{ t }}: {{ c }}</span>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- RIGHT: filters (split into two inner boxes to reduce clutter) -->
      <div class="col-lg-8">
        <div class="p-3 border rounded-3 bg-white shadow-sm">
          <div class="fw-semibold mb-2">Filter</div>

          <form method="get" action="{{ url_for('photos.photos') }}">
            <div class="row g-3">
              <!-- Inner box A -->
              <div class="col-md-6">
                <div class="p-3 border rounded-3 bg-light h-100">
                  <div class="fw-semibold mb-2">Basic</div>

                  <div class="mb-2">
                    <label class="form-label">Date from</label>
                    <input type="date" name="datum_from" class="form-control" value="{{ filters.datum_from or '' }}">
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Date to</label>
                    <input type="date" name="datum_to" class="form-control" value="{{ filters.datum_to or '' }}">
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Photo type</label>
                    <select name="photo_typ" class="form-select" multiple>
                      {% for t in photo_typ_choices %}
                        <option value="{{ t }}" {% if t in filters.photo_typ %}selected{% endif %}>{{ t }}</option>
                      {% endfor %}
                    </select>
                    <div class="form-text">Hold Ctrl/âŒ˜ to select multiple.</div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Author</label>
                    <div class="search-select"
                         data-mode="multi"
                         data-endpoint="{{ url_for('photos.api_search_authors') }}"
                         data-hidden-name="author"
                         data-placeholder="Filter: author">
                    </div>
                  </div>

                  <div class="d-flex gap-3 mt-2">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="has_gps" value="1" id="chkGps"
                             {% if filters.has_gps %}checked{% endif %}>
                      <label class="form-check-label" for="chkGps">Has GPS</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="orphan_only" value="1" id="chkOrphan"
                             {% if filters.orphan_only %}checked{% endif %}>
                      <label class="form-check-label" for="chkOrphan">Orphans only</label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Inner box B -->
              <div class="col-md-6">
                <div class="p-3 border rounded-3 bg-light h-100">
                  <div class="fw-semibold mb-2">Entities</div>

                  <div class="mb-2">
                    <label class="form-label">SUs</label>
                    <div class="search-select"
                         data-mode="multi"
                         data-endpoint="{{ url_for('photos.api_search_sj') }}"
                         data-hidden-name="sj_ids"
                         data-placeholder="Filter: SU">
                    </div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Polygons</label>
                    <div class="search-select"
                         data-mode="multi"
                         data-endpoint="{{ url_for('photos.api_search_polygons') }}"
                         data-hidden-name="polygon_names"
                         data-placeholder="Filter: polygon">
                    </div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Sections</label>
                    <div class="search-select"
                         data-mode="multi"
                         data-endpoint="{{ url_for('photos.api_search_sections') }}"
                         data-hidden-name="section_ids"
                         data-placeholder="Filter: section">
                    </div>
                  </div>

                  <div class="mb-2">
                    <label class="form-label">Finds</label>
                    <div class="search-select"
                         data-mode="multi"
                         data-endpoint="{{ url_for('photos.api_search_finds') }}"
                         data-hidden-name="find_ids"
                         data-placeholder="Filter: find">
                    </div>
                  </div>

                  <div class="mb-0">
                    <label class="form-label">Samples</label>
                    <div class="search-select"
                         data-mode="multi"
                         data-endpoint="{{ url_for('photos.api_search_samples') }}"
                         data-hidden-name="sample_ids"
                         data-placeholder="Filter: sample">
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Apply filter</button>
                <a class="btn btn-outline-secondary" href="{{ url_for('photos.photos') }}">Reset</a>
              </div>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="modalEdit" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="post" class="modal-content" id="editForm">
      <div class="modal-header">
        <h5 class="modal-title">Edit photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2 text-muted small" id="editIdPhoto"></div>

        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Photo type</label>
            <select class="form-select" name="photo_typ" required>
              {% for t in photo_typ_choices %}
                <option value="{{ t }}">{{ t }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Date</label>
            <input type="date" class="form-control" name="datum" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Author</label>
            <div class="search-select"
                 data-mode="single"
                 data-endpoint="{{ url_for('photos.api_search_authors') }}"
                 data-hidden-name="author"
                 data-placeholder="Type to search author...">
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Notes</label>
            <input type="text" class="form-control" name="notes" placeholder="optional">
          </div>
        </div>

        <hr class="my-3">

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">SUs</label>
            <div class="search-select"
                 data-mode="multi"
                 data-endpoint="{{ url_for('photos.api_search_sj') }}"
                 data-hidden-name="ref_sj"
                 data-placeholder="Type to search SU...">
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Polygons</label>
            <div class="search-select"
                 data-mode="multi"
                 data-endpoint="{{ url_for('photos.api_search_polygons') }}"
                 data-hidden-name="ref_polygon"
                 data-placeholder="Type to search polygon...">
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Sections</label>
            <div class="search-select"
                 data-mode="multi"
                 data-endpoint="{{ url_for('photos.api_search_sections') }}"
                 data-hidden-name="ref_section"
                 data-placeholder="Type to search section...">
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Finds</label>
            <div class="search-select"
                 data-mode="multi"
                 data-endpoint="{{ url_for('photos.api_search_finds') }}"
                 data-hidden-name="ref_find"
                 data-placeholder="Type to search find...">
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Samples</label>
            <div class="search-select"
                 data-mode="multi"
                 data-endpoint="{{ url_for('photos.api_search_samples') }}"
                 data-hidden-name="ref_sample"
                 data-placeholder="Type to search sample...">
            </div>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Replace file (optional)</label>
          <input type="file" name="replace_file" class="form-control"
                 accept=".jpeg,.jpg,.png,.tiff,.svg,.pdf">
          <div class="form-text">Replace = overwrite existing file + regenerate thumbnail.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="modalDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" class="modal-content" id="deleteForm">
      <div class="modal-header">
        <h5 class="modal-title">Delete photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="mb-1">Delete photo:</p>
        <div class="fw-semibold" id="deleteIdPhoto"></div>
        <div class="text-muted small mt-2">This will delete DB record, links and files on disk.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger">Delete</button>
      </div>
    </form>
  </div>
</div>


<!-- HELP MODAL -->
<div class="modal fade" id="helPhotosUpload" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Help: Photos upload</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% include 'help/photos_help.html' %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/photos.js') }}"></script>
{% endblock %}
